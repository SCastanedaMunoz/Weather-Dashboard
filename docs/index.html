<!DOCTYPE html>
<html lang="en_US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Weather Dashboard</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
 
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Added link to the jQuery library -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

     <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>


    <header><strong><h1>Weather Dashboard<h1></strong></header>

    <div class="city-history">
        <div>
            <h4>Search for a City:</h4>

            <div class="search-holder input-group mb-3">
                <input id="city-input" type="text" class="form-control" placeholder="City's Name" aria-label="City's Name" aria-describedby="button-search">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="button-search"><i class="fa fa-search" aria-hidden="true"></i></button>
                </div>
            </div>

            <ul class="list-group" id="city-history"></ul>
        </div>
    </div>

    <div class="city-display" >
        <div class="card fluid">
            <div class="card-body">
                <h2 id="city-name" class="city-item"></h2>
                <div id ="city-temp" class="city-item"></div>
                <div id ="city-humd" class="city-item"></div>
                <div id ="city-wind" class="city-item"></div>
                <div id ="city-uvin" class="city-item"></div>
            </div>
        </div>
    </div>

    <div class="forecast-holder">
        <h4>5-Day Forecast:</h4>
        <div class="city-forecast"></div>
    </div>

    <!-- Custom Logic -->
    <script>

        $(document).ready(function() {

            var cityHistory = ["Austin", "Chicago", "New York", "Orlando", "San Francisco", "Seattle", "Denver", "Atlanta"];
            var lastSearchedCity = "Austin";
            const apiKey = "43b58455665ab44ce81cff40a4aa69d9";

            initialize();

            function initialize() {
                fillOutCityHistory();
                fetchCityWeather(lastSearchedCity);

                $("#button-search").on("click", function(event) {

                    var inputCity = $("#city-input").val();

                    if (inputCity == "") {
                        // TODO add modal? 
                        return;
                    }

                    fetchCityWeather(inputCity);
                });
            }

            function fillOutCityHistory() {

                // todo - fill with last 8 researched cities

                var cityHistoryList = $("#city-history");

                $(cityHistoryList).empty();

                for (var i = 0; i < cityHistory.length; i ++) {
                    var liElement = $("<li>");
                    $(liElement).addClass("list-group-item history-item");

                    if(cityHistory[i] === lastSearchedCity)
                        $(liElement).addClass("active");

                    // todo - add text from storage
                    // todo - set last search city as active
                    $(liElement).text(cityHistory[i]);
                    $(cityHistoryList).append(liElement);
                }

                $(".history-item").on("click", function(event) {
                    var cityName = $(this).text();

                    fetchCityWeather(cityName);
                });
            }

            function fetchCityWeather(cityName) {
                
                var queryURL = `https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${apiKey}`;

                $.ajax({
                    url : queryURL,
                    method : "GET"
                }).then(function(response){

                    if(cityHistory.indexOf(cityName) < 0) {

                        $("#city-history").empty();
                        cityHistory.pop();
                        cityHistory.splice(0, 0, cityName);
                    }
         
                    lastSearchedCity = cityName;

                    fillOutCityHistory();

                    var date = new Date();

                    $("#city-name").text(`${response.name} (${date.getMonth()}/${date.getDate()}/${date.getFullYear()})`);
                    var icon = $(`<img src="https://openweathermap.org/img/wn/${response.weather[0].icon}@2x.png", alt="city-icon" class="city-icon"/>`);
                    $("#city-name").append(icon);

                    var tempK = response.main.temp;
                    var tempF = (tempK - 273.15) * 9/5 + 32;

                    $("#city-temp").html(`Temperature: ${tempF.toFixed(0)} &deg;F`);
                    $("#city-humd").html(`Humidity: ${response.main.humidity}%`);
                    $("#city-wind").html(`Wind Speed: ${response.wind.speed} MPH`);

                    fetchUVIndex(response.coord.lat, response.coord.lon);

                    fetchCity5DayForecast(cityName);
                }).fail(function(xhr, status, error) {
                    console.log(error);
                });

                function fetchUVIndex(lat, lon){
                    var queryURL = `https://api.openweathermap.org/data/2.5/uvi?appid=${apiKey}&lat=${lat}&lon=${lon}`;

                    $.ajax({
                        url : queryURL,
                        method : "GET"
                    }).then(function(response){
                        $("#city-uvin").html(`UV Index: <button class="btn btn-danger">${response.value}</button>` );
                    });
                }

                function fetchCity5DayForecast(cityName) {

                    var queryURL = `https://api.openweathermap.org/data/2.5/forecast?q=${cityName}&appid=${apiKey}`;

                    $.ajax({
                        url : queryURL,
                        method : "GET"
                    }).then(function(response){
                        var fiveDays6Am = [];

                        for (var i = 4; i < response.list.length && i < response.list.length; i += 8)
                            fiveDays6Am.push(response.list[i]);

                        var cityForecast = $(".city-forecast");
                        $(cityForecast).empty();

                        for (var i = 0; i < fiveDays6Am.length; i++)
                        {
                            var dayDate = new Date(fiveDays6Am[i].dt_txt);
                            var cityCard = $("<div>");
                            $(cityCard).addClass("card fluid bg-primary city-forecast-day");
                            var cityBody = $("<div>");
                            $(cityBody).addClass("card-body forecast-body");

                            var forecastDate = $("<h4>");

                            $(forecastDate).html(`${(dayDate.getMonth() + 1)}/${dayDate.getDate()}/${dayDate.getFullYear()}`);

                            var imgIcon = $("<img>");
                            $(imgIcon).addClass("forecast-icon");
                            $(imgIcon).attr("src", `https://openweathermap.org/img/wn/${fiveDays6Am[i].weather[0].icon}@2x.png`);
                            $(imgIcon).attr("alt", `city-forecast-icon-${(i + 1)}`);

                            var forecastTemp = $("<div>");

                            var tempK = fiveDays6Am[i].main.temp;
                            var tempF = (tempK - 273.15) * 9/5 + 32;

                            $(forecastTemp).addClass("forecast-item");
                            $(forecastTemp).html(`Temp: ${tempF.toFixed(2)} &deg;F`);

                            var forecastHumd = $("<div>");

                            $(forecastHumd).html(`Humidity: ${43}%`);

                            $(cityBody).append(forecastDate, imgIcon, forecastTemp, forecastHumd);

                            $(cityCard).append(cityBody);

                            $(cityForecast).append(cityCard);
                        }
                    });
                }
            }
        });

    </script>
  </body>
</html>
